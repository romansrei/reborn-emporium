<script>
  document.addEventListener("DOMContentLoaded", function () {
    const listings = JSON.parse(localStorage.getItem("listings") || "[]");
    const justListedGrid = document.getElementById("justListedGrid");
    const alternativeGrid = document.getElementById("alternativeGrid");
    const adoptionGrid = document.getElementById("adoptionGrid");
    const filters = document.querySelectorAll(".filter");

    filters.forEach(f => f.addEventListener("change", renderJustListed));

    function createCard(listing) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        ${listing.image ? `<img src="${listing.image}" alt="${listing.title}" />` : '<img src="https://via.placeholder.com/300x400.png?text=Doll" alt="Placeholder">'}
        ${listing.status?.toLowerCase() === 'sold' ? '<div class="badge">SOLD</div>' : ''}
        <h3>${listing.title}</h3>
        ${listing.preOwned === true ? '<div class="preowned">Pre-Owned</div>' : ''}
        <div class="material">${listing.material || ''}</div>
        <div class="meta">
          Artist: ${listing.artist || 'Unknown'}<br>
          Seller: ${listing.sellerName || 'Unknown'}<br>
          ${listing.nurseryName ? `Nursery: ${listing.nurseryName}` : ''}
        </div>
        <div class="price">$${listing.price}</div>
        <a href="doll-detail.html?id=${listing.id}">View Details</a>
      `;
      return card;
    }

    function renderJustListed() {
      console.log("Rendering Just Listed...");
      const active = Array.from(filters).filter(cb => cb.checked).map(cb => cb.value);
      const humanListings = listings.filter(l => l.category?.toLowerCase() === "human");
      const latest = humanListings.slice(-30).reverse();
      justListedGrid.innerHTML = "";

      const filtered = latest.filter(l => {
        return active.every(tag => {
          const text = (l.title + l.description + l.material + l.eyes + l.awakeAsleep + l.notes + l.status).toLowerCase();
          return text.includes(tag);
        });
      });

      filtered.slice(0, 16).forEach(listing => {
        justListedGrid.appendChild(createCard(listing));
      });
    }

    function renderAlternative() {
      const altListings = listings.filter(l => l.category?.toLowerCase() === "alternative").slice(-10).reverse();
      alternativeGrid.innerHTML = "";
      altListings.slice(0, 4).forEach(listing => {
        alternativeGrid.appendChild(createCard(listing));
      });
    }

    function renderForAdoption() {
      const unsold = listings.filter(l => l.category?.toLowerCase() === "human" && l.status?.toLowerCase() === "available");
      const shuffled = unsold.sort(() => Math.random() - 0.5);
      adoptionGrid.innerHTML = "";
      shuffled.slice(0, 60).forEach(listing => {
        adoptionGrid.appendChild(createCard(listing));
      });
    }

    renderJustListed();
    renderAlternative();
    renderForAdoption();
  });
</script>
